name: Komfort Chain - Full CI/CD (Multi-Module + Security)

on:
  push:
    branches: ["main"]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-analyze:
    name: Build All Modules & Analyze (SonarCloud)
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Setup JDK
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin

      # 3. Cache Maven & SonarCloud
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      # 4. Build e Testes
      - name: Build and test (Login Service)
        working-directory: login-service
        run: mvn -B clean verify -DskipTests=false

      - name: Build and test (API Gateway)
        working-directory: api-gateway
        run: mvn -B clean verify -DskipTests=false

      # 5. Mesclar relatórios JaCoCo
      - name: Merge JaCoCo Reports
        run: |
          mkdir -p target/jacoco-aggregate
          find . -type f -name "jacoco.xml" -exec cp {} target/jacoco-aggregate/ \;
          echo "<report><group name='Komfort Chain Coverage'>" > target/jacoco-aggregate/merged.xml
          grep -h "<counter " target/jacoco-aggregate/*.xml >> target/jacoco-aggregate/merged.xml
          echo "</group></report>" >> target/jacoco-aggregate/merged.xml

      # 6. Análise unificada no SonarCloud
      - name: Analyze All Modules (SonarCloud)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B org.sonarsource.scanner.maven:sonar-maven-plugin:5.3.0.6276:sonar \
            -Dsonar.projectKey=Komfort-chain_modulo2 \
            -Dsonar.organization=komfort-chain \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/jacoco-aggregate/merged.xml \
            -Dsonar.sources=login-service/src/main/java,api-gateway/src/main/java \
            -Dsonar.java.binaries=login-service/target/classes,api-gateway/target/classes \
            -Dsonar.junit.reportPaths=login-service/target/surefire-reports,api-gateway/target/surefire-reports

      # 7. Upload de artefatos
      - name: Upload JaCoCo Reports
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-reports
          path: |
            login-service/target/site/jacoco/
            api-gateway/target/site/jacoco/
            target/jacoco-aggregate/

      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: |
            login-service/target/surefire-reports/
            api-gateway/target/surefire-reports/

  # --------------------------------------------------------
  # JOB 2 — OWASP Dependency-Check
  # --------------------------------------------------------
  security-scan:
    name: OWASP Dependency-Check (Vulnerability Scan)
    runs-on: ubuntu-latest
    needs: build-and-analyze

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin

      - name: Install OWASP Dependency-Check
        run: |
          curl -sL https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.3/dependency-check-10.0.3-release.zip -o depcheck.zip
          unzip -q depcheck.zip -d $HOME/depcheck

      - name: Run OWASP Dependency-Check on login-service
        run: |
          $HOME/depcheck/dependency-check/bin/dependency-check.sh \
            --project "Login Service" \
            --scan login-service \
            --format "ALL" \
            --out reports/login-service

      - name: Run OWASP Dependency-Check on api-gateway
        run: |
          $HOME/depcheck/dependency-check/bin/dependency-check.sh \
            --project "API Gateway" \
            --scan api-gateway \
            --format "ALL" \
            --out reports/api-gateway

      - name: Upload Dependency-Check Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: reports/
