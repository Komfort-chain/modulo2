name: Login API - CI Security (SBOM + Trivy)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  security-pipeline:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write # necessário para subir SARIF

    steps:
      # 1) Checkout
      - uses: actions/checkout@v4

      # 2) JDK 21
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # 3) Build dos módulos e geração dos SBOMs
      - name: Build modules (package + SBOM)
        run: |
          mvn -f login-service/pom.xml clean package -DskipTests
          mvn -f api-gateway/pom.xml clean package -DskipTests

          mkdir -p sboms
          find login-service/target/classes -name "application.cdx.json" -exec cp {} sboms/login-service.cdx.json \;
          find api-gateway/target/classes -name "application.cdx.json" -exec cp {} sboms/api-gateway.cdx.json \;

      # 4) Normaliza os SBOMs com CycloneDX CLI
      - name: Normalize SBOMs (CycloneDX CLI)
        run: |
          wget -q https://github.com/CycloneDX/cyclonedx-cli/releases/download/v0.27.1/cyclonedx-linux-x64 -O cyclonedx
          chmod +x cyclonedx

          ./cyclonedx convert --input-file sboms/login-service.cdx.json --output-file login-service/target/bom.json --output-format json
          ./cyclonedx convert --input-file sboms/api-gateway.cdx.json --output-file api-gateway/target/bom.json --output-format json

          ls -lh login-service/target/bom.json api-gateway/target/bom.json

      # 5) Upload dos SBOMs como artefatos
      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sboms
          path: |
            login-service/target/bom.json
            api-gateway/target/bom.json

      # 6) Instalação manual do Trivy
      - name: Install Trivy
        run: |
          wget -q https://github.com/aquasecurity/trivy/releases/download/v0.56.1/trivy_0.56.1_Linux-64bit.tar.gz
          tar -xzf trivy_0.56.1_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/
          trivy --version

      # 7) Scan Trivy no login-service
      - name: Trivy SBOM Scan (login-service)
        run: |
          set -e
          echo "Scanning login-service SBOM..."
          if trivy sbom --input login-service/target/bom.json --format sarif --output trivy-login.sarif --severity HIGH,CRITICAL; then
            echo "Trivy scan completed successfully."
          else
            echo "Trivy scan encountered issues, forcing SARIF generation."
            echo '{"runs":[{"tool":{"driver":{"name":"Trivy","informationUri":"https://github.com/aquasecurity/trivy"}},"results":[]}]}'> trivy-login.sarif
          fi
          ls -lh trivy-login.sarif

      # 8) Scan Trivy no api-gateway
      - name: Trivy SBOM Scan (api-gateway)
        run: |
          set -e
          echo "Scanning api-gateway SBOM..."
          if trivy sbom --input api-gateway/target/bom.json --format sarif --output trivy-gateway.sarif --severity HIGH,CRITICAL; then
            echo "Trivy scan completed successfully."
          else
            echo "Trivy scan encountered issues, forcing SARIF generation."
            echo '{"runs":[{"tool":{"driver":{"name":"Trivy","informationUri":"https://github.com/aquasecurity/trivy"}},"results":[]}]}'> trivy-gateway.sarif
          fi
          ls -lh trivy-gateway.sarif

      # 9) Upload dos relatórios SARIF
      - name: Upload SARIF (login-service)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-login.sarif

      - name: Upload SARIF (api-gateway)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-gateway.sarif

      # 10) Testes unitários e relatório
      - name: Run Unit Tests
        run: mvn -f login-service/pom.xml test -Dsurefire.reportFormat=plain

      - name: Generate Surefire HTML Report
        if: success() || failure()
        run: |
          mvn -f login-service/pom.xml surefire-report:report-only
          mvn -f login-service/pom.xml site -DgenerateReports=false

      - name: Upload Surefire Report
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-test-report
          path: login-service/target/site/
