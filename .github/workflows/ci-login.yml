name: Login API - CI Security (SBOM + Trivy)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  security-pipeline:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write # necessário para subir SARIF

    steps:
      # 1) Checkout do código
      - uses: actions/checkout@v4

      # 2) Configuração do JDK 21
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # 3) Build + geração de SBOM (CycloneDX)
      - name: Build modules (package + SBOM)
        run: |
          mvn -f login-service/pom.xml clean package -DskipTests
          mvn -f api-gateway/pom.xml clean package -DskipTests

          echo "Copiando SBOMs para local padrão..."
          find login-service/target/classes -name "application.cdx.json" -exec cp {} login-service/target/bom.json \; || echo "SBOM não encontrado no login-service"
          find api-gateway/target/classes -name "application.cdx.json" -exec cp {} api-gateway/target/bom.json \; || echo "SBOM não encontrado no api-gateway"

          echo "Adicionando campo 'bomFormat': 'CycloneDX' para compatibilidade com Trivy..."
          sudo apt-get install -y jq
          for file in login-service/target/bom.json api-gateway/target/bom.json; do
            if [ -f "$file" ]; then
              jq '. + {"bomFormat": "CycloneDX"}' "$file" > tmp.$$.json && mv tmp.$$.json "$file"
            fi
          done

          echo "SBOMs prontos para o scan:"
          ls -lh login-service/target/bom.json || true
          ls -lh api-gateway/target/bom.json || true

      # 4) Upload dos SBOMs como artefatos
      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sboms
          path: |
            login-service/target/bom.json
            api-gateway/target/bom.json

      # 5) Varredura de vulnerabilidades com Trivy (baseada no SBOM)
      - name: Trivy SBOM scan (login-service)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: sbom
          input: login-service/target/bom.json
          format: sarif
          output: trivy-login.sarif
          severity: HIGH,CRITICAL
          exit-code: "0" # apenas reporta

      - name: Trivy SBOM scan (api-gateway)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: sbom
          input: api-gateway/target/bom.json
          format: sarif
          output: trivy-gateway.sarif
          severity: HIGH,CRITICAL
          exit-code: "0"

      # 6) Upload dos relatórios SARIF para o GitHub Code Scanning
      - name: Upload SARIF (login-service)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-login.sarif

      - name: Upload SARIF (api-gateway)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-gateway.sarif

      # 7) Testes unitários e relatório Surefire
      - name: Run Unit Tests
        run: mvn -f login-service/pom.xml test -Dsurefire.reportFormat=plain

      - name: Generate Surefire HTML Report
        if: success() || failure()
        run: |
          mvn -f login-service/pom.xml surefire-report:report-only
          mvn -f login-service/pom.xml site -DgenerateReports=false

      - name: Upload Surefire Report
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-test-report
          path: login-service/target/site/
