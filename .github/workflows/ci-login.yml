name: Login API - CI Security (SBOM + Trivy)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  security-pipeline:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write # necessário para subir SARIF

    steps:
      # 1) Checkout
      - uses: actions/checkout@v4

      # 2) JDK 21
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # 3) Build + SBOM
      - name: Build modules and generate SBOMs
        run: |
          mvn -f login-service/pom.xml clean package -DskipTests
          mvn -f api-gateway/pom.xml clean package -DskipTests

          mkdir -p sboms
          find login-service/target/classes -name "application.cdx.json" -exec cp {} sboms/login-service.cdx.json \;
          find api-gateway/target/classes -name "application.cdx.json" -exec cp {} sboms/api-gateway.cdx.json \;

      # 4) Instala CycloneDX CLI e valida/converte SBOMs
      - name: Normalize SBOMs (CycloneDX CLI)
        run: |
          echo "Instalando CycloneDX CLI..."
          wget -q https://github.com/CycloneDX/cyclonedx-cli/releases/download/v0.27.1/cyclonedx-linux-x64 -O cyclonedx
          chmod +x cyclonedx

          echo "Normalizando SBOMs..."
          ./cyclonedx validate --input-file sboms/login-service.cdx.json || true
          ./cyclonedx convert --input-file sboms/login-service.cdx.json --output-file login-service/target/bom.json --output-format json

          ./cyclonedx validate --input-file sboms/api-gateway.cdx.json || true
          ./cyclonedx convert --input-file sboms/api-gateway.cdx.json --output-file api-gateway/target/bom.json --output-format json

          ls -lh login-service/target/bom.json api-gateway/target/bom.json

      # 5) Upload dos SBOMs
      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sboms
          path: |
            login-service/target/bom.json
            api-gateway/target/bom.json

      # 6) Scans Trivy (agora reconhece formato)
      - name: Trivy SBOM scan (login-service)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: sbom
          input: login-service/target/bom.json
          format: sarif
          output: trivy-login.sarif
          severity: HIGH,CRITICAL
          exit-code: "0"

      - name: Trivy SBOM scan (api-gateway)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: sbom
          input: api-gateway/target/bom.json
          format: sarif
          output: trivy-gateway.sarif
          severity: HIGH,CRITICAL
          exit-code: "0"

      # 7) Upload SARIFs
      - name: Upload SARIF (login-service)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-login.sarif

      - name: Upload SARIF (api-gateway)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-gateway.sarif

      # 8) Testes unitários e relatório
      - name: Run Unit Tests
        run: mvn -f login-service/pom.xml test -Dsurefire.reportFormat=plain

      - name: Generate Surefire HTML Report
        if: success() || failure()
        run: |
          mvn -f login-service/pom.xml surefire-report:report-only
          mvn -f login-service/pom.xml site -DgenerateReports=false

      - name: Upload Surefire Report
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-test-report
          path: login-service/target/site/
