name: Login API - CI Security (SBOM + Trivy)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  security-pipeline:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write # necessário para subir SARIF

    steps:
      # 1) Checkout
      - uses: actions/checkout@v4

      # 2) JDK 21
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # 3) Build + gera SBOM (CycloneDX) para ambos os módulos
      - name: Build modules (package + SBOM)
        run: |
          mvn -f login-service/pom.xml clean package -DskipTests
          mvn -f api-gateway/pom.xml clean package -DskipTests
          test -f login-service/target/bom.json
          test -f api-gateway/target/bom.json

      # 4) Publica SBOM como artefato
      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sboms
          path: |
            login-service/target/bom.json
            api-gateway/target/bom.json

      # 5) Scans com Trivy (usa SBOM CycloneDX) -> SARIF para code scanning
      - name: Trivy SBOM scan (login-service)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: sbom
          input: login-service/target/bom.json
          format: sarif
          output: trivy-login.sarif
          severity: HIGH,CRITICAL
          exit-code: "0" # não falha o job; só reporta

      - name: Trivy SBOM scan (api-gateway)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: sbom
          input: api-gateway/target/bom.json
          format: sarif
          output: trivy-gateway.sarif
          severity: HIGH,CRITICAL
          exit-code: "0"

      # 6) Sobe SARIF (aparece em Security > Code scanning alerts)
      - name: Upload SARIF (login-service)
        uses: github/code-scanning/upload-sarif@v3
        with:
          sarif_file: trivy-login.sarif

      - name: Upload SARIF (api-gateway)
        uses: github/code-scanning/upload-sarif@v3
        with:
          sarif_file: trivy-gateway.sarif

      # 7) Testes unitários + relatório Surefire (como antes)
      - name: Run Unit Tests
        run: mvn -f login-service/pom.xml test -Dsurefire.reportFormat=plain

      - name: Generate Surefire HTML Report
        if: success() || failure()
        run: |
          mvn -f login-service/pom.xml surefire-report:report-only
          mvn -f login-service/pom.xml site -DgenerateReports=false

      - name: Upload Surefire Report
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-test-report
          path: login-service/target/site/
